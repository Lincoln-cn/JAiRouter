name: æ–‡æ¡£å†…å®¹åŒæ­¥æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'docs/**'
      - 'src/main/resources/application.yml'
      - 'pom.xml'
      - 'Dockerfile*'
      - 'docker-compose*.yml'
  pull_request:
    branches: [ main, develop ]
    paths: 
      - 'docs/**'
      - 'src/main/resources/application.yml'
      - 'pom.xml'
      - 'Dockerfile*'
      - 'docker-compose*.yml'
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œä¸€æ¬¡
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  content-sync-check:
    name: æ£€æŸ¥æ–‡æ¡£å†…å®¹åŒæ­¥æ€§
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
    
    - name: è¿è¡Œæ–‡æ¡£å†…å®¹åŒæ­¥æ£€æŸ¥
      id: sync-check
      run: |
        python scripts/docs/check-docs-sync.py \
          --project-root . \
          --output docs-sync-report.md \
          --fail-on-error
    
    - name: ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docs-sync-report
        path: docs-sync-report.md
        retention-days: 30
    
    - name: æ·»åŠ  PR è¯„è®º (å¦‚æœæœ‰é—®é¢˜)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = fs.readFileSync('docs-sync-report.md', 'utf8');
            
            const comment = `## ğŸ“‹ æ–‡æ¡£å†…å®¹åŒæ­¥æ£€æŸ¥æŠ¥å‘Š
            
            æ£€æŸ¥å‘ç°äº†ä¸€äº›éœ€è¦æ³¨æ„çš„é—®é¢˜ï¼š
            
            ${report}
            
            ---
            
            ğŸ’¡ **å»ºè®®**: è¯·æ£€æŸ¥å¹¶ä¿®å¤ä¸Šè¿°é—®é¢˜ï¼Œç¡®ä¿æ–‡æ¡£ä¸ä»£ç ä¿æŒåŒæ­¥ã€‚
            
            ğŸ”§ **æœ¬åœ°è¿è¡Œ**: 
            \`\`\`bash
            python scripts/docs/check-docs-sync.py --project-root . --fail-on-error
            \`\`\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('æ— æ³•è¯»å–æŠ¥å‘Šæ–‡ä»¶æˆ–æ·»åŠ è¯„è®º:', error.message);
          }
    
    - name: æ£€æŸ¥ç»“æœæ€»ç»“
      if: always()
      run: |
        if [ -f "docs-sync-report.md" ]; then
          echo "## ğŸ“‹ æ–‡æ¡£åŒæ­¥æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          cat docs-sync-report.md >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.sync-check.outcome }}" = "success" ]; then
          echo "âœ… æ–‡æ¡£å†…å®¹åŒæ­¥æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ æ–‡æ¡£å†…å®¹åŒæ­¥æ£€æŸ¥å‘ç°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤ç›¸å…³é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
        fi

  windows-compatibility-check:
    name: Windows å…¼å®¹æ€§æ£€æŸ¥
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è¿è¡Œ PowerShell ç‰ˆæœ¬æ£€æŸ¥
      shell: powershell
      run: |
        # è®¾ç½®æ‰§è¡Œç­–ç•¥
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        
        # è¿è¡Œ PowerShell ç‰ˆæœ¬çš„åŒæ­¥æ£€æŸ¥
        try {
          .\scripts\docs\check-docs-sync.ps1 -ProjectRoot . -OutputFile "docs-sync-report-windows.md"
          Write-Host "âœ… Windows PowerShell ç‰ˆæœ¬æ£€æŸ¥å®Œæˆ" -ForegroundColor Green
        }
        catch {
          Write-Host "âŒ Windows PowerShell ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
          exit 1
        }
    
    - name: ä¸Šä¼  Windows æ£€æŸ¥æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docs-sync-report-windows
        path: docs-sync-report-windows.md
        retention-days: 30