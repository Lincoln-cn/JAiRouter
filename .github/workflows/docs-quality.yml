name: æ–‡æ¡£è´¨é‡æ£€æŸ¥

on:
  pull_request:
    paths: 
      - 'docs/**'
      - 'mkdocs.yml'
      - '*.md'
  push:
    branches: [ main, master ]
    paths: 
      - 'docs/**'
      - 'mkdocs.yml'
      - '*.md'

jobs:
  quality-check:
    runs-on: ubuntu-latest
    name: æ–‡æ¡£è´¨é‡æ£€æŸ¥
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£… MkDocs ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install mkdocs-material
        pip install mkdocs-git-revision-date-localized-plugin
        pip install mkdocs-mermaid2-plugin
        pip install mkdocs-static-i18n
        pip install mkdocs-minify-plugin

    - name: éªŒè¯ MkDocs é…ç½®
      run: |
        mkdocs build --strict --verbose
        echo "âœ… MkDocs é…ç½®éªŒè¯é€šè¿‡"
    
    - name: æ£€æŸ¥ Markdown è¯­æ³•
      uses: DavidAnson/markdownlint-cli2-action@v20
      with:
        files: '**/*.md'
        config: '.markdownlint.json'
        ignore: 'node_modules'
        fix: false
    
    - name: æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§ (ç¬¬ä¸‰æ–¹å·¥å…·)
      uses: tcort/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/mlc_config.json'
        folder-path: 'docs'
        file-path: './README.md, ./README-EN.md'
      continue-on-error: true
    
    - name: æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§ (è‡ªå®šä¹‰è„šæœ¬)
      run: |
        python3 scripts/docs/check-links.py --dir docs --output link-check-report.json --fail-on-error
        echo "âœ… é“¾æ¥æ£€æŸ¥å®Œæˆ"
    
    - name: ä¸Šä¼ é“¾æ¥æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: link-check-report
        path: link-check-report.json
    
    - name: æ£€æŸ¥æ–‡æ¡£ç»“æ„
      run: |
        python3 -c "
        import os
        import sys
        
        # æ£€æŸ¥å¿…éœ€çš„æ–‡æ¡£ç›®å½•æ˜¯å¦å­˜åœ¨
        required_dirs = [
            'docs/getting-started',
            'docs/configuration', 
            'docs/api-reference',
            'docs/deployment',
            'docs/monitoring',
            'docs/development',
            'docs/troubleshooting',
            'docs/reference'
        ]
        
        missing_dirs = []
        for dir_path in required_dirs:
            if not os.path.exists(dir_path):
                missing_dirs.append(dir_path)
        
        if missing_dirs:
            print('âŒ ç¼ºå°‘å¿…éœ€çš„æ–‡æ¡£ç›®å½•:')
            for dir_path in missing_dirs:
                print(f'  - {dir_path}')
            sys.exit(1)
        else:
            print('âœ… æ–‡æ¡£ç›®å½•ç»“æ„æ£€æŸ¥é€šè¿‡')
                "
            
    - name: æ£€æŸ¥æ–‡æ¡£å…ƒæ•°æ®
      run: |
        python3 -c "
        import os
        import re
        
        def check_frontmatter(file_path):
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ frontmatter
            if content.startswith('---'):
                end_pos = content.find('---', 3)
                if end_pos > 0:
                    return True
            return False
        
        # æ£€æŸ¥ä¸»è¦æ–‡æ¡£æ–‡ä»¶çš„å…ƒæ•°æ®
        docs_files = []
        for root, dirs, files in os.walk('docs'):
            for file in files:
                if file.endswith('.md'):
                    docs_files.append(os.path.join(root, file))
        
        if docs_files:
            print(f'ğŸ“‹ æ£€æŸ¥äº† {len(docs_files)} ä¸ªæ–‡æ¡£æ–‡ä»¶')
            print('âœ… æ–‡æ¡£å…ƒæ•°æ®æ£€æŸ¥å®Œæˆ')
        else:
            print('âš ï¸  æœªæ‰¾åˆ°æ–‡æ¡£æ–‡ä»¶')
                "
  spell-check:
    runs-on: ubuntu-latest
    name: æ‹¼å†™æ£€æŸ¥
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: æ‹¼å†™æ£€æŸ¥
      uses: streetsidesoftware/cspell-action@v5
      with:
        files: |
          docs/**/*.md
          *.md
        config: '.cspell.json'
        incremental_files_only: false
