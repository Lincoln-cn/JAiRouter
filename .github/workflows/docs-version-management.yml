name: æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'docs/**/*.md'
      - 'README*.md'
      - '*.md'
  pull_request:
    branches: [ main, develop ]
    paths: 
      - 'docs/**/*.md'
      - 'README*.md'
      - '*.md'
  schedule:
    # æ¯å¤© UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_only:
        description: 'ä»…æ‰«æç‰ˆæœ¬ä¿¡æ¯ï¼ˆä¸æäº¤æ›´æ”¹ï¼‰'
        required: false
        default: false
        type: boolean
      add_headers:
        description: 'æ·»åŠ ç‰ˆæœ¬å¤´ä¿¡æ¯'
        required: false
        default: false
        type: boolean
      cleanup_days:
        description: 'æ¸…ç†å¤šå°‘å¤©å‰çš„å˜æ›´è®°å½•'
        required: false
        default: '90'
        type: string

jobs:
  version-management:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿ Git ä¿¡æ¯æ”¶é›†
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: è®¾ç½® PowerShell ç¯å¢ƒ (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "PowerShell ç‰ˆæœ¬: $($PSVersionTable.PSVersion)"
    
    - name: æ‰«ææ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯
      id: scan
      run: |
        echo "ğŸ” æ‰«ææ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯..."
        
        # ä½¿ç”¨ Python ç‰ˆæœ¬è¿›è¡Œæ‰«æ
        python scripts/docs/docs-version-manager.py --project-root . --scan
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -f .kiro/docs-versions.json ]; then
          CHANGES_COUNT=$(python -c "import json; with open('docs/docs-versions.json', 'r', encoding='utf-8') as f: data = json.load(f); print(len(data.get('changes', [])))")
          echo "changes_count=$CHANGES_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“Š å‘ç° $CHANGES_COUNT ä¸ªå˜æ›´è®°å½•"
        else
          echo "changes_count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: æ·»åŠ ç‰ˆæœ¬å¤´ä¿¡æ¯
      if: github.event.inputs.add_headers == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
      run: |
        echo "ğŸ“‹ æ·»åŠ ç‰ˆæœ¬å¤´ä¿¡æ¯..."
        python scripts/docs/docs-version-manager.py --project-root . --add-headers
    
    - name: æ¸…ç†æ—§å˜æ›´è®°å½•
      if: github.event.inputs.cleanup_days != '' || github.event_name == 'schedule'
      run: |
        CLEANUP_DAYS="${{ github.event.inputs.cleanup_days || '90' }}"
        echo "ğŸ§¹ æ¸…ç† $CLEANUP_DAYS å¤©å‰çš„å˜æ›´è®°å½•..."
        python scripts/docs/docs-version-manager.py --project-root . --cleanup $CLEANUP_DAYS
    
    - name: ç”Ÿæˆç‰ˆæœ¬æŠ¥å‘Š
      id: report
      run: |
        echo "ğŸ“Š ç”Ÿæˆç‰ˆæœ¬æŠ¥å‘Š..."
        python scripts/docs/docs-version-manager.py --project-root . --report docs-version-report.md
        
        # æ£€æŸ¥è¿‡æœŸæ–‡æ¡£
        python scripts/docs/docs-version-manager.py --project-root . --check-outdated 30 > outdated-check.txt 2>&1 || true
        
        if grep -q "å‘ç°.*ä¸ªè¿‡æœŸæ–‡æ¡£" outdated-check.txt; then
          echo "has_outdated=true" >> $GITHUB_OUTPUT
          OUTDATED_COUNT=$(grep -o "å‘ç° [0-9]* ä¸ªè¿‡æœŸæ–‡æ¡£" outdated-check.txt | grep -o "[0-9]*")
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
        else
          echo "has_outdated=false" >> $GITHUB_OUTPUT
          echo "outdated_count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: å¯¼å‡ºç‰ˆæœ¬æ•°æ®
      run: |
        echo "ğŸ“¤ å¯¼å‡ºç‰ˆæœ¬æ•°æ®..."
        python scripts/docs/docs-version-manager.py --project-root . --export docs-version-data.json
        python scripts/docs/docs-version-manager.py --project-root . --export docs-version-data.csv
    
    - name: ä¸Šä¼ ç‰ˆæœ¬æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: docs-version-report
        path: |
          docs-version-report.md
          docs-version-data.json
          docs-version-data.csv
          outdated-check.txt
        retention-days: 30
    
    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: changes
      run: |
        if git diff --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´:"
          git diff --name-only
        fi
    
    - name: æäº¤ç‰ˆæœ¬ä¿¡æ¯æ›´æ–°
      if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.scan_only != 'true' && github.event_name != 'pull_request'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .kiro/docs-versions.json
        git add docs/**/*.md || true
        git add README*.md || true
        git add *.md || true
        
        git commit -m "docs: æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯ [skip ci] - æ‰«æäº†æ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯ - å‘ç° ${{ steps.scan.outputs.changes_count }} ä¸ªå˜æ›´ - è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬æ ‡è¯†å’Œä¾èµ–å…³ç³» Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
        
        git push
    
    - name: åˆ›å»ºè¿‡æœŸæ–‡æ¡£æé†’ Issue
      if: steps.report.outputs.has_outdated == 'true' && github.event_name == 'schedule'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // è¯»å–è¿‡æœŸæ–‡æ¡£æ£€æŸ¥ç»“æœ
          const outdatedCheck = fs.readFileSync('outdated-check.txt', 'utf8');
          const reportContent = fs.readFileSync('docs-version-report.md', 'utf8');
          
          // æå–è¿‡æœŸæ–‡æ¡£éƒ¨åˆ†
          const outdatedSection = reportContent.match(/## è¿‡æœŸæ–‡æ¡£.*?(?=##|$)/s);
          const outdatedContent = outdatedSection ? outdatedSection[0] : 'æœªæ‰¾åˆ°è¿‡æœŸæ–‡æ¡£è¯¦æƒ…';
          
          const issueTitle = `ğŸ“‹ æ–‡æ¡£ç»´æŠ¤æé†’ï¼šå‘ç° ${{ steps.report.outputs.outdated_count }} ä¸ªè¿‡æœŸæ–‡æ¡£éœ€è¦æ›´æ–°`;
          const issueBody = `## ğŸ“Š è¿‡æœŸæ–‡æ¡£æ£€æŸ¥æŠ¥å‘Š åœ¨å®šæœŸæ£€æŸ¥ä¸­å‘ç°äº†ä¸€äº›è¶…è¿‡ 30 å¤©æœªæ›´æ–°çš„æ–‡æ¡£ï¼Œå»ºè®®è¿›è¡Œå†…å®¹å®¡æŸ¥å’Œæ›´æ–°ã€‚ ${outdatedContent} ## ğŸ”§ å»ºè®®æ“ä½œ 1. **å®¡æŸ¥å†…å®¹**: æ£€æŸ¥è¿‡æœŸæ–‡æ¡£çš„å†…å®¹æ˜¯å¦ä»ç„¶å‡†ç¡® 2. **æ›´æ–°ä¿¡æ¯**: æ›´æ–°è¿‡æ—¶çš„ä¿¡æ¯ã€é“¾æ¥å’Œç¤ºä¾‹ 3. **éªŒè¯åŠŸèƒ½**: ç¡®ä¿æ–‡æ¡£ä¸­çš„æ“ä½œæ­¥éª¤ä»ç„¶æœ‰æ•ˆ 4. **åŒæ­¥ä»£ç **: æ£€æŸ¥æ–‡æ¡£æ˜¯å¦ä¸æœ€æ–°ä»£ç ä¿æŒä¸€è‡´ ## ğŸ“ˆ ç‰ˆæœ¬ç®¡ç†ä¿¡æ¯ - æ£€æŸ¥æ—¶é—´: ${new Date().toISOString().split('T')[0]} - è¿‡æœŸé˜ˆå€¼: 30 å¤© - æ€»æ–‡æ¡£æ•°: é€šè¿‡ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿè·Ÿè¸ª - è‡ªåŠ¨åŒ–: æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º ## ğŸ”— ç›¸å…³èµ„æº - [æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†é…ç½®](.kiro/docs-version-config.yml) - [ç‰ˆæœ¬ç®¡ç†è„šæœ¬](scripts/docs/docs-version-manager.py) - [å®Œæ•´ç‰ˆæœ¬æŠ¥å‘Š](../../actions/runs/${{ github.run_id }}) --- *æ­¤ Issue ç”±æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºï¼Œæ¯æ—¥æ£€æŸ¥è¿‡æœŸæ–‡æ¡£å¹¶æé†’ç»´æŠ¤ã€‚*`;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„ Issue
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'documentation,maintenance,automated',
            state: 'open'
          });
          
          const existingIssue = issues.find(issue => 
            issue.title.includes('æ–‡æ¡£ç»´æŠ¤æé†’') && 
            issue.title.includes('è¿‡æœŸæ–‡æ¡£')
          );
          
          if (existingIssue) {
            // æ›´æ–°ç°æœ‰ Issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `## ğŸ“… ${new Date().toISOString().split('T')[0]} æ›´æ–°\n\n${issueBody}`
            });
            
            console.log(`æ›´æ–°äº†ç°æœ‰ Issue #${existingIssue.number}`);
          } else {
            // åˆ›å»ºæ–° Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['documentation', 'maintenance', 'automated']
            });
            
            console.log('åˆ›å»ºäº†æ–°çš„è¿‡æœŸæ–‡æ¡£æé†’ Issue');
          }
    
    - name: PR è¯„è®º - ç‰ˆæœ¬ä¿¡æ¯
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          if (!fs.existsSync('docs-version-report.md')) {
            console.log('ç‰ˆæœ¬æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡è¯„è®º');
            return;
          }
          
          const reportContent = fs.readFileSync('docs-version-report.md', 'utf8');
          
          // æå–æœ€è¿‘å˜æ›´éƒ¨åˆ†
          const recentChangesMatch = reportContent.match(/## æœ€è¿‘å˜æ›´\n(.*?)(?=\n##|\n$)/s);
          const recentChanges = recentChangesMatch ? recentChangesMatch[1].trim() : 'æ— æœ€è¿‘å˜æ›´';
          
          const comment = `## ğŸ“‹ æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†æŠ¥å‘Š æ­¤ PR æ¶‰åŠæ–‡æ¡£å˜æ›´ï¼Œä»¥ä¸‹æ˜¯ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿçš„åˆ†æç»“æœï¼š ### ğŸ“Š å˜æ›´ç»Ÿè®¡ - å˜æ›´è®°å½•æ•°: ${{ steps.scan.outputs.changes_count }} - è¿‡æœŸæ–‡æ¡£æ•°: ${{ steps.report.outputs.outdated_count }} ### ğŸ“ æœ€è¿‘å˜æ›´ ${recentChanges} ### ğŸ” æ£€æŸ¥é¡¹ç›® - âœ… æ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–° - âœ… ä¾èµ–å…³ç³»å·²æ£€æµ‹ - âœ… Git ä¿¡æ¯å·²æ”¶é›† ${steps.report.outputs.has_outdated == 'true' ? '- âš ï¸ å‘ç°è¿‡æœŸæ–‡æ¡£ï¼Œå»ºè®®æ›´æ–°' : '- âœ… æ— è¿‡æœŸæ–‡æ¡£'} --- *æ­¤è¯„è®ºç”±æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });
    
    - name: è¾“å‡ºæ‰§è¡Œæ‘˜è¦
      run: |
        echo "## ğŸ“‹ æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- å˜æ›´è®°å½•æ•°: ${{ steps.scan.outputs.changes_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- è¿‡æœŸæ–‡æ¡£æ•°: ${{ steps.report.outputs.outdated_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ–‡ä»¶å˜æ›´: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”§ æ‰§è¡Œæ“ä½œ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ‰«ææ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.add_headers }}" == "true" ] || [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "- âœ… æ·»åŠ ç‰ˆæœ¬å¤´ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -n "${{ github.event.inputs.cleanup_days }}" ] || [ "${{ github.event_name }}" == "schedule" ]; then
          echo "- âœ… æ¸…ç†æ—§å˜æ›´è®°å½•" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- âœ… ç”Ÿæˆç‰ˆæœ¬æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å¯¼å‡ºç‰ˆæœ¬æ•°æ®" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“„ ç”Ÿæˆæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- ç‰ˆæœ¬æŠ¥å‘Š: \[docs-version-report.md\](file://D:\IdeaProjects\model-router\docs-version-report.md)" >> $GITHUB_STEP_SUMMARY
        echo "- ç‰ˆæœ¬æ•°æ®: \`docs-version-data.json\`, \`docs-version-data.csv\`" >> $GITHUB_STEP_SUMMARY
        echo "- ç‰ˆæœ¬é…ç½®: \`.kiro/docs-versions.json\`" >> $GITHUB_STEP_SUMMARY