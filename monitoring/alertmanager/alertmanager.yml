# AlertManageré…ç½®æ–‡ä»¶
# ç”¨äºé…ç½®å‘Šè­¦è·¯ç”±ã€æ¥æ”¶å™¨å’ŒæŠ‘åˆ¶è§„åˆ™

global:
  # SMTPé…ç½®ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰
  smtp_smarthost: 'localhost:587'
  smtp_from: 'jairouter-alerts@example.com'
  smtp_auth_username: 'jairouter-alerts@example.com'
  smtp_auth_password: 'your-email-password'
  smtp_require_tls: true

  # å…¶ä»–å…¨å±€é…ç½®
  resolve_timeout: 5m
  http_config:
    follow_redirects: true

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶å™¨
  receiver: 'default-receiver'
  
  # åˆ†ç»„é…ç½®
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  
  # å­è·¯ç”±é…ç½®
  routes:
    # ä¸¥é‡å‘Šè­¦ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      
    # è­¦å‘Šçº§åˆ«å‘Šè­¦
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 30m
      
    # JAiRouterç‰¹å®šå‘Šè­¦
    - match_re:
        alertname: '^JAiRouter.*'
      receiver: 'jairouter-alerts'
      group_wait: 15s
      repeat_interval: 15m

# æŠ‘åˆ¶è§„åˆ™é…ç½®
inhibit_rules:
  # å½“æœ‰ä¸¥é‡å‘Šè­¦æ—¶ï¼ŒæŠ‘åˆ¶ç›¸åŒæœåŠ¡çš„è­¦å‘Šå‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'instance']

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default-receiver'
    webhook_configs:
      - url: 'http://localhost:9093/api/v1/alerts'
        send_resolved: true
        http_config:
          follow_redirects: true

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: 'ops-team@example.com'
        subject: '[CRITICAL] JAiRouter Alert: {{ .GroupLabels.alertname }}'
        body: |
          ğŸš¨ JAiRouterä¸¥é‡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          ğŸ“‹ å‘Šè­¦ä¿¡æ¯:
          - å‘Šè­¦åç§°: {{ .Annotations.summary }}
          - è¯¦ç»†æè¿°: {{ .Annotations.description }}
          - æœåŠ¡å®ä¾‹: {{ .Labels.instance }}
          - å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          - å¼€å§‹æ—¶é—´: {{ .StartsAt }}
          {{ if .EndsAt }}
          - ç»“æŸæ—¶é—´: {{ .EndsAt }}
          {{ end }}
          
          ğŸ·ï¸ æ ‡ç­¾ä¿¡æ¯:
          {{ range .Labels.SortedPairs }}
          - {{ .Name }}: {{ .Value }}
          {{ end }}
          
          ğŸ”— ç›‘æ§é“¾æ¥:
          - Grafana: http://localhost:3000/d/jairouter-overview
          - Prometheus: http://localhost:9090/alerts
          
          {{ end }}
          
          âš ï¸ è¯·ç«‹å³å¤„ç†æ­¤ä¸¥é‡å‘Šè­¦ï¼
        headers:
          Priority: 'high'
          X-Priority: '1'
    
    # Slacké€šçŸ¥é…ç½®
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#jairouter-alerts'
        username: 'JAiRouter-AlertManager'
        icon_emoji: ':rotating_light:'
        title: 'ğŸš¨ JAiRouterä¸¥é‡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *å®ä¾‹*: {{ .Labels.instance }}
          *çº§åˆ«*: {{ .Labels.severity }}
          *æ—¶é—´*: {{ .StartsAt }}
          {{ end }}
        send_resolved: true
    
    # é’‰é’‰é€šçŸ¥é…ç½®
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_DINGTALK_TOKEN'
        send_resolved: true
        http_config:
          headers:
            Content-Type: 'application/json'
        title: 'JAiRouterä¸¥é‡å‘Šè­¦'
        text: |
          {
            "msgtype": "markdown",
            "markdown": {
              "title": "JAiRouterä¸¥é‡å‘Šè­¦",
              "text": "## ğŸš¨ JAiRouterä¸¥é‡å‘Šè­¦\n\n{{ range .Alerts }}**å‘Šè­¦åç§°**: {{ .Annotations.summary }}\n\n**è¯¦ç»†æè¿°**: {{ .Annotations.description }}\n\n**æœåŠ¡å®ä¾‹**: {{ .Labels.instance }}\n\n**å‘Šè­¦çº§åˆ«**: {{ .Labels.severity }}\n\n**å¼€å§‹æ—¶é—´**: {{ .StartsAt }}\n\n---\n\n{{ end }}è¯·ç«‹å³å¤„ç†æ­¤ä¸¥é‡å‘Šè­¦ï¼"
            }
          }

  # è­¦å‘Šå‘Šè­¦æ¥æ”¶å™¨
  - name: 'warning-alerts'
    email_configs:
      - to: 'dev-team@example.com'
        subject: '[WARNING] JAiRouter Alert: {{ .GroupLabels.alertname }}'
        body: |
          âš ï¸ JAiRouterè­¦å‘Šå‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          ğŸ“‹ å‘Šè­¦ä¿¡æ¯:
          - å‘Šè­¦åç§°: {{ .Annotations.summary }}
          - è¯¦ç»†æè¿°: {{ .Annotations.description }}
          - æœåŠ¡å®ä¾‹: {{ .Labels.instance }}
          - å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          - å¼€å§‹æ—¶é—´: {{ .StartsAt }}
          {{ if .EndsAt }}
          - ç»“æŸæ—¶é—´: {{ .EndsAt }}
          {{ end }}
          
          ğŸ·ï¸ æ ‡ç­¾ä¿¡æ¯:
          {{ range .Labels.SortedPairs }}
          - {{ .Name }}: {{ .Value }}
          {{ end }}
          
          ğŸ”— ç›‘æ§é“¾æ¥:
          - Grafana: http://localhost:3000/d/jairouter-overview
          - Prometheus: http://localhost:9090/alerts
          
          {{ end }}
          
          è¯·å…³æ³¨å¹¶å¤„ç†æ­¤å‘Šè­¦ã€‚
        headers:
          X-Priority: '3'
    
    # Slacké€šçŸ¥é…ç½®
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#jairouter-monitoring'
        username: 'JAiRouter-AlertManager'
        icon_emoji: ':warning:'
        title: 'âš ï¸ JAiRouterè­¦å‘Šå‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *å®ä¾‹*: {{ .Labels.instance }}
          *çº§åˆ«*: {{ .Labels.severity }}
          *æ—¶é—´*: {{ .StartsAt }}
          {{ end }}
        send_resolved: true

  # JAiRouterç‰¹å®šå‘Šè­¦æ¥æ”¶å™¨
  - name: 'jairouter-alerts'
    email_configs:
      - to: 'jairouter-team@example.com'
        subject: '[JAiRouter] {{ .GroupLabels.alertname }}'
        body: |
          ğŸ¤– JAiRouteræœåŠ¡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          ğŸ“Š ç›‘æ§æŒ‡æ ‡å‘Šè­¦:
          - å‘Šè­¦åç§°: {{ .Annotations.summary }}
          - è¯¦ç»†æè¿°: {{ .Annotations.description }}
          - æœåŠ¡å®ä¾‹: {{ .Labels.instance }}
          - å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          - å¼€å§‹æ—¶é—´: {{ .StartsAt }}
          {{ if .EndsAt }}
          - ç»“æŸæ—¶é—´: {{ .EndsAt }}
          {{ end }}
          
          ğŸ” é—®é¢˜æ’æŸ¥å»ºè®®:
          {{ if eq .Labels.alertname "JAiRouterHighErrorRate" }}
          1. æ£€æŸ¥åº”ç”¨æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
          2. éªŒè¯åç«¯æœåŠ¡çš„å¯ç”¨æ€§
          3. æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
          {{ else if eq .Labels.alertname "JAiRouterHighLatency" }}
          1. æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
          2. åˆ†ææ…¢æŸ¥è¯¢å’Œæ€§èƒ½ç“¶é¢ˆ
          3. éªŒè¯åç«¯æœåŠ¡å“åº”æ—¶é—´
          {{ else if eq .Labels.alertname "JAiRouterBackendDown" }}
          1. æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
          2. éªŒè¯ç½‘ç»œè¿æ¥
          3. æ£€æŸ¥æœåŠ¡é…ç½®
          {{ else }}
          1. æŸ¥çœ‹Grafanaä»ªè¡¨æ¿äº†è§£è¯¦ç»†æƒ…å†µ
          2. æ£€æŸ¥ç›¸å…³æ—¥å¿—æ–‡ä»¶
          3. éªŒè¯ç³»ç»Ÿé…ç½®
          {{ end }}
          
          ğŸ”— ç›¸å…³é“¾æ¥:
          - Grafanaä»ªè¡¨æ¿: http://localhost:3000/d/jairouter-overview
          - Prometheuså‘Šè­¦: http://localhost:9090/alerts
          - åº”ç”¨æ—¥å¿—: http://localhost:8080/actuator/loggers
          
          {{ end }}
          
          è¯·åŠæ—¶å¤„ç†ç›¸å…³é—®é¢˜ï¼Œç¡®ä¿æœåŠ¡ç¨³å®šè¿è¡Œã€‚
        headers:
          X-Priority: '3'
    
    # ä¼ä¸šå¾®ä¿¡é€šçŸ¥é…ç½®
    wechat_configs:
      - corp_id: 'YOUR_CORP_ID'
        agent_id: 'YOUR_AGENT_ID'
        api_secret: 'YOUR_API_SECRET'
        to_user: '@all'
        message: |
          JAiRouteræœåŠ¡å‘Šè­¦
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          å®ä¾‹: {{ .Labels.instance }}
          çº§åˆ«: {{ .Labels.severity }}
          æ—¶é—´: {{ .StartsAt }}
          {{ end }}

  # ä¸šåŠ¡å›¢é˜Ÿå‘Šè­¦æ¥æ”¶å™¨
  - name: 'business-alerts'
    email_configs:
      - to: 'business-team@example.com'
        subject: '[ä¸šåŠ¡å‘Šè­¦] JAiRouter {{ .GroupLabels.alertname }}'
        body: |
          ğŸ“ˆ JAiRouterä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
          
          {{ range .Alerts }}
          ä¸šåŠ¡å½±å“åˆ†æ:
          - å‘Šè­¦ç±»å‹: {{ .Annotations.summary }}
          - å½±å“æè¿°: {{ .Annotations.description }}
          - æœåŠ¡å®ä¾‹: {{ .Labels.instance }}
          - å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          - å‘ç”Ÿæ—¶é—´: {{ .StartsAt }}
          
          {{ if eq .Labels.alertname "JAiRouterModelCallFailureRate" }}
          ğŸ¯ ä¸šåŠ¡å½±å“:
          - AIæ¨¡å‹è°ƒç”¨å¤±è´¥ç‡ä¸Šå‡
          - å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ
          - å»ºè®®æ£€æŸ¥æ¨¡å‹æœåŠ¡çŠ¶æ€
          {{ else if eq .Labels.alertname "JAiRouterHighConcurrentConnections" }}
          ğŸ¯ ä¸šåŠ¡å½±å“:
          - å¹¶å‘ç”¨æˆ·æ•°è¾ƒé«˜
          - ç³»ç»Ÿè´Ÿè½½å¢åŠ 
          - å¯èƒ½éœ€è¦æ‰©å®¹
          {{ else }}
          ğŸ¯ ä¸šåŠ¡å½±å“:
          - è¯·å…³æ³¨ç›¸å…³ä¸šåŠ¡æŒ‡æ ‡
          - è¯„ä¼°å¯¹ç”¨æˆ·çš„å½±å“
          {{ end }}
          
          {{ end }}
          
          è¯·è¯„ä¼°ä¸šåŠ¡å½±å“å¹¶åè°ƒå¤„ç†ã€‚

  # å®‰å…¨å›¢é˜Ÿå‘Šè­¦æ¥æ”¶å™¨  
  - name: 'security-alerts'
    email_configs:
      - to: 'security-team@example.com'
        subject: '[å®‰å…¨å‘Šè­¦] JAiRouter {{ .GroupLabels.alertname }}'
        body: |
          ğŸ”’ JAiRouterå®‰å…¨å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å®‰å…¨äº‹ä»¶è¯¦æƒ…:
          - å‘Šè­¦ç±»å‹: {{ .Annotations.summary }}
          - äº‹ä»¶æè¿°: {{ .Annotations.description }}
          - æœåŠ¡å®ä¾‹: {{ .Labels.instance }}
          - å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          - å‘ç”Ÿæ—¶é—´: {{ .StartsAt }}
          
          {{ if eq .Labels.alertname "JAiRouterSuspiciousIPActivity" }}
          ğŸš¨ å®‰å…¨å»ºè®®:
          - ç«‹å³æ£€æŸ¥å¯ç–‘IPçš„è®¿é—®æ¨¡å¼
          - è€ƒè™‘ä¸´æ—¶å°ç¦å¼‚å¸¸IP
          - åˆ†æè®¿é—®æ—¥å¿—ç¡®è®¤å¨èƒ
          {{ else if eq .Labels.alertname "JAiRouterHighAuthFailureRate" }}
          ğŸš¨ å®‰å…¨å»ºè®®:
          - æ£€æŸ¥æ˜¯å¦å­˜åœ¨æš´åŠ›ç ´è§£æ”»å‡»
          - éªŒè¯è®¤è¯ç³»ç»ŸçŠ¶æ€
          - è€ƒè™‘åŠ å¼ºè®¿é—®æ§åˆ¶
          {{ end }}
          
          {{ end }}
          
          è¯·ç«‹å³è¿›è¡Œå®‰å…¨è¯„ä¼°å’Œå¤„ç†ã€‚
        headers:
          Priority: 'high'
          X-Priority: '2'

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'